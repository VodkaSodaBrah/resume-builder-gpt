version: '3.8'

services:
  # Main application (frontend + API)
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3000:3000"   # Frontend
      - "7071:7071"   # API
    environment:
      - NODE_ENV=production
      - AZURE_STORAGE_CONNECTION_STRING=${AZURE_STORAGE_CONNECTION_STRING}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-7d}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - APP_URL=${APP_URL:-http://localhost:3000}
    depends_on:
      - azurite
    networks:
      - resume-builder-network

  # Azure Storage Emulator for local development
  azurite:
    image: mcr.microsoft.com/azure-storage/azurite
    ports:
      - "10000:10000"  # Blob
      - "10001:10001"  # Queue
      - "10002:10002"  # Table
    volumes:
      - azurite-data:/data
    command: azurite --blobHost 0.0.0.0 --queueHost 0.0.0.0 --tableHost 0.0.0.0 -l /data
    networks:
      - resume-builder-network

  # Development mode - hot reload
  dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    ports:
      - "3000:3000"   # Vite dev server
      - "7071:7071"   # Azure Functions
    environment:
      - NODE_ENV=development
      - AZURE_STORAGE_CONNECTION_STRING=UseDevelopmentStorage=true;DevelopmentStorageProxyUri=http://azurite
      - JWT_SECRET=${JWT_SECRET:-dev-secret-change-in-production-at-least-32-chars}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-7d}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - APP_URL=http://localhost:3000
    volumes:
      - .:/app
      - /app/node_modules
      - /app/api/node_modules
    depends_on:
      - azurite
    networks:
      - resume-builder-network

networks:
  resume-builder-network:
    driver: bridge

volumes:
  azurite-data:
